<div
  class="bg-muted flex min-h-svh flex-col items-center justify-center p-6 md:p-10"
>
  <div class="w-full max-w-sm md:max-w-4xl">
    <div class="flex flex-col gap-6">
      <div
        class="bg-card text-card-foreground overflow-hidden rounded-lg border shadow-sm p-0"
      >
        <div class="grid p-0 md:grid-cols-2">
          <!-- Left side: Login Form -->
          <form
            id="changePasswordForm"
            method="post"
            action="<%= basePath %>/interaction/<%= uid %>/change-password"
            class="p-6 md:border-r md:p-8"
            novalidate
          >
            <div class="flex flex-col gap-6">
              <!-- Header -->
              <div class="flex flex-col items-center gap-2 text-center">
                <h1 class="text-2xl font-bold">Welcome to VM-X AI</h1>
                <p class="text-muted-foreground text-balance">
                  Change your password
                </p>
              </div>

              <!-- Error message container -->
              <div
                id="errorMessage"
                class="bg-destructive/10 text-destructive border-destructive/20 rounded-md border p-3 text-sm hidden"
              >
                <p id="errorText"></p>
              </div>

              <!-- Username/Email Field -->
              <div class="flex flex-col gap-2">
                <label
                  for="password"
                  class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
                >
                  New Password
                </label>
                <input
                  id="password"
                  name="password"
                  type="password"
                  required
                  autocomplete="new-password"
                  class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                  placeholder="Enter your new password"
                />
                <p
                  id="passwordError"
                  class="text-destructive text-xs hidden"
                ></p>
              </div>

              <!-- Password Field -->
              <div class="flex flex-col gap-2">
                <div class="flex items-center">
                  <label
                    for="confirmPassword"
                    class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
                  >
                    Confirm Password
                  </label>
                </div>
                <input
                  id="confirmPassword"
                  name="confirmPassword"
                  type="password"
                  required
                  autocomplete="confirm-password"
                  class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                  placeholder="Confirm your new password"
                />
                <p
                  id="confirmPasswordError"
                  class="text-destructive text-xs hidden"
                ></p>
              </div>

              <!-- Submit Button -->
              <div>
                <button
                  type="submit"
                  class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2 w-full"
                >
                  Change Password
                </button>
              </div>
            </div>
          </form>

          <!-- Right side: Logo/Image -->
          <div class="relative hidden md:block">
            <div
              class="absolute inset-0 flex flex-col items-center justify-center gap-4 p-12"
            >
              <img
                src="<%= basePath %>/assets/logos/vm-x-login.png"
                alt="VM-X AI"
                class="h-32 w-auto"
              />
              <p class="text-muted-foreground text-center text-sm max-w-xs">
                Level up to Enterprise Grade AI
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="px-6 text-center">
        <p class="text-muted-foreground text-sm">
          By continuing, you agree to our
          <a
            href="https://vm-x.ai/terms-of-service"
            class="underline-offset-2 underline"
            >Terms of Service</a
          >
          and
          <a href="https://vm-x.ai/privacy" class="underline-offset-2 underline"
            >Privacy Policy</a
          >.
        </p>
      </div>
    </div>
  </div>
</div>

<script>
  (function () {
    const form = document.getElementById('changePasswordForm');
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    const passwordError = document.getElementById('passwordError');
    const confirmPasswordError = document.getElementById('confirmPasswordError');
    const errorMessage = document.getElementById('errorMessage');
    const errorText = document.getElementById('errorText');

    // Password validation regex matching the schema
    const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_+\-=\\[\]{};':"\\|,.<>\\/?]).{8,32}$/;

    function validatePassword(password) {
      if (!password || !password.trim()) {
        return 'Password is required.';
      }
      if (password.length < 8) {
        return 'Password must be at least 8 characters long.';
      }
      if (password.length > 32) {
        return 'Password must be at most 32 characters long.';
      }
      if (!passwordRegex.test(password)) {
        return 'Password must contain at least one uppercase letter, one lowercase letter, one number, and one special character.';
      }
      return null;
    }

    function showError(field, message) {
      const errorElement = field === 'password' ? passwordError : confirmPasswordError;
      const inputElement = field === 'password' ? passwordInput : confirmPasswordInput;

      errorElement.textContent = message;
      errorElement.classList.remove('hidden');
      inputElement.classList.add('border-destructive');
      inputElement.classList.remove('border-input');
    }

    function clearError(field) {
      const errorElement = field === 'password' ? passwordError : confirmPasswordError;
      const inputElement = field === 'password' ? passwordInput : confirmPasswordInput;

      errorElement.classList.add('hidden');
      inputElement.classList.remove('border-destructive');
      inputElement.classList.add('border-input');
    }

    function showGlobalError(message) {
      errorText.textContent = message;
      errorMessage.classList.remove('hidden');
    }

    function clearGlobalError() {
      errorMessage.classList.add('hidden');
    }

    // Real-time validation
    passwordInput.addEventListener('blur', function () {
      const error = validatePassword(this.value);
      if (error) {
        showError('password', error);
      } else {
        clearError('password');
        // Also check if passwords match when password is valid
        if (confirmPasswordInput.value && this.value !== confirmPasswordInput.value) {
          showError('confirmPassword', 'Passwords must match.');
        } else if (confirmPasswordInput.value) {
          clearError('confirmPassword');
        }
      }
    });

    confirmPasswordInput.addEventListener('blur', function () {
      if (!this.value) {
        showError('confirmPassword', 'Confirm password is required.');
      } else if (passwordInput.value && this.value !== passwordInput.value) {
        showError('confirmPassword', 'Passwords must match.');
      } else {
        clearError('confirmPassword');
      }
    });

    // Clear errors on input
    passwordInput.addEventListener('input', function () {
      const error = validatePassword(this.value);
      if (!error) {
        clearError('password');
        clearGlobalError();
        // Check password match if confirm password has a value
        if (confirmPasswordInput.value) {
          if (this.value !== confirmPasswordInput.value) {
            showError('confirmPassword', 'Passwords must match.');
          } else {
            clearError('confirmPassword');
          }
        }
      }
    });

    confirmPasswordInput.addEventListener('input', function () {
      if (this.value && passwordInput.value) {
        if (this.value !== passwordInput.value) {
          showError('confirmPassword', 'Passwords must match.');
        } else {
          clearError('confirmPassword');
          clearGlobalError();
        }
      } else if (this.value) {
        clearError('confirmPassword');
        clearGlobalError();
      }
    });

    // Form submission validation
    form.addEventListener('submit', function (e) {
      let isValid = true;
      clearGlobalError();

      // Validate password
      const passwordErrorMsg = validatePassword(passwordInput.value);
      if (passwordErrorMsg) {
        showError('password', passwordErrorMsg);
        isValid = false;
      } else {
        clearError('password');
      }

      // Validate confirm password
      if (!confirmPasswordInput.value) {
        showError('confirmPassword', 'Confirm password is required.');
        isValid = false;
      } else if (passwordInput.value !== confirmPasswordInput.value) {
        showError('confirmPassword', 'Passwords must match.');
        isValid = false;
      } else {
        clearError('confirmPassword');
      }

      if (!isValid) {
        e.preventDefault();
        showGlobalError('Please fill in all required fields and ensure the passwords match.');
        return false;
      }

      // Disable submit button to prevent double submission
      const submitButton = form.querySelector('button[type="submit"]');
      submitButton.disabled = true;
      submitButton.textContent = 'Changing password...';
    });

    // Check for URL error parameters (e.g., from failed login)
    const urlParams = new URLSearchParams(window.location.search);
    const error = urlParams.get('error');
    if (error) {
      showGlobalError('Invalid credentials. Please try again.');
    }
  })();
</script>
